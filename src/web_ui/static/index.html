<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Drone System Dashboard</title>

  <!-- ‚úÖ Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    crossorigin=""
  />
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<header>
  <h1>Drone System Dashboard</h1>
  <nav>
    <button class="tab-btn active" data-tab="orders">üõ∞Ô∏è Orders</button>
    <button class="tab-btn" data-tab="settings">‚öôÔ∏è Settings</button>
    <button class="tab-btn" data-tab="fleet">üöÅ Fleet</button>
  </nav>
</header>

<main>
  <!-- ========== –í–∫–ª–∞–¥–∫–∞ Orders ========== -->
  <section id="orders" class="tab active">
    <div id="orders-panel">
      <h2>–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ </h2>
      <form id="orderForm">
        <label>–ü—É–Ω–∫—Ç A (–∑–∞–±—Ä–∞—Ç—å):</label><br>
        <input id="from-lat" placeholder="lat" type="number" step="0.000001">
        <input id="from-lon" placeholder="lon" type="number" step="0.000001"><br>

        <label>–ü—É–Ω–∫—Ç B (–¥–æ—Å—Ç–∞–≤–∏—Ç—å):</label><br>
        <input id="to-lat" placeholder="lat" type="number" step="0.000001">
        <input id="to-lon" placeholder="lon" type="number" step="0.000001"><br>

        <label>–î—Ä–æ–Ω:</label>
        <select id="droneSelect"></select><br>

        <label>–í–µ—Å –≥—Ä—É–∑–∞ (–∫–≥):</label>
        <input id="orderWeight" type="number" value="5" step="0.1"><br>

        <button type="submit">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
      </form>

      <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h3>
      <ul id="orders-list"></ul>
    </div>

    <div id="map"></div>
  </section>

  <!-- ========== –í–∫–ª–∞–¥–∫–∞ Settings ========== -->
  <section id="settings" class="tab">
    <div id="settings-panel">
      <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
      <form id="settingsForm">
        <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±–∞–∑—ã:</label><br>
        <input id="base-lat" placeholder="lat" type="number" step="0.000001">
        <input id="base-lon" placeholder="lon" type="number" step="0.000001"><br>

        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥—Ä–æ–Ω–æ–≤:</label>
        <input id="drone-count" type="number" value="1"><br>

        <label>–°–∫–æ—Ä–æ—Å—Ç—å —Å–∏–º—É–ª—è—Ü–∏–∏:</label>
        <input id="sim-speed" type="number" value="1.0" step="0.1"><br>

        <label>MQTT-—Ö–æ—Å—Ç:</label>
        <input id="mqtt-host" type="text" value="localhost"><br>

        <label>MAVSDK-–ø–æ—Ä—Ç:</label>
        <input id="mavsdk-port" type="number" value="14540"><br>

        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </form>
    </div>
  </section>

  <!-- ========== –í–∫–ª–∞–¥–∫–∞ Fleet ========== -->
  <section id="fleet" class="tab">
    <div id="fleet-panel">
      <h2>–§–ª–æ—Ç –¥—Ä–æ–Ω–æ–≤</h2>
      <table id="fleet-table">
        <thead>
        <tr>
          <th>ID</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
          <th>–ü–æ–∑–∏—Ü–∏—è</th>
          <th>–ë–∞—Ç–∞—Ä–µ—è</th>
          <th>–ú–∏—Å—Å–∏—è</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<!-- ‚úÖ Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>

<!-- ‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const map = L.map('map').setView([43.0747, -89.3842], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const droneMarkers = {};
  let pickupMarker = null;
  let dropoffMarker = null;

  // === WebSocket ===
  const socket = new WebSocket(`ws://${window.location.host}/ws`);

  socket.onopen = () => console.log("‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω");
  socket.onmessage = (event) => {
    const msg = JSON.parse(event.data);

    if (msg.type === "telemetry_update" && msg.payload) {
      const id = msg.topic.split("/")[1];
      const { lat, lon } = msg.payload;
      if (!lat || !lon) return;

      if (!droneMarkers[id]) {
        const marker = L.marker([lat, lon]).addTo(map)
          .bindPopup(`üöÅ Drone ${id}`);
        droneMarkers[id] = marker;
      } else {
        droneMarkers[id].setLatLng([lat, lon]);
      }
    }

    if (msg.type === "mission_planned" && msg.payload?.waypoints) {
      const id = msg.topic.split("/")[1];
      const coords = msg.payload.waypoints.map(w => [w.lat, w.lon]);
      const polyline = L.polyline(coords, { color: 'blue', weight: 2 }).addTo(map);
      polyline.bindPopup(`üì¶ –ú–∞—Ä—à—Ä—É—Ç –¥—Ä–æ–Ω–∞ ${id}`);
    }
  };

  // === –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ ===
  map.on('click', (e) => {
    const { lat, lng } = e.latlng;

    // –ü–µ—Ä–≤–∞—è —Ç–æ—á–∫–∞ ‚Äî –ø—É–Ω–∫—Ç A (pickup)
    if (!pickupMarker) {
      pickupMarker = L.marker([lat, lng], { draggable: true, icon: greenIcon() })
        .addTo(map)
        .bindPopup("–ü—É–Ω–∫—Ç A (–∑–∞–±—Ä–∞—Ç—å)")
        .openPopup();

      document.getElementById("from-lat").value = lat.toFixed(6);
      document.getElementById("from-lon").value = lng.toFixed(6);
    }

    // –í—Ç–æ—Ä–∞—è —Ç–æ—á–∫–∞ ‚Äî –ø—É–Ω–∫—Ç B (dropoff)
    else if (!dropoffMarker) {
      dropoffMarker = L.marker([lat, lng], { draggable: true, icon: redIcon() })
        .addTo(map)
        .bindPopup("–ü—É–Ω–∫—Ç B (–¥–æ—Å—Ç–∞–≤–∏—Ç—å)")
        .openPopup();

      document.getElementById("to-lat").value = lat.toFixed(6);
      document.getElementById("to-lon").value = lng.toFixed(6);

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑
      createOrder();
    }

    // –ï—Å–ª–∏ –æ–±–µ —Ç–æ—á–∫–∏ —É–∂–µ –µ—Å—Ç—å ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
    else {
      map.removeLayer(pickupMarker);
      map.removeLayer(dropoffMarker);
      pickupMarker = null;
      dropoffMarker = null;
    }
  });

  // === –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞ ===
  async function createOrder() {
    const fromLat = parseFloat(document.getElementById("from-lat").value);
    const fromLon = parseFloat(document.getElementById("from-lon").value);
    const toLat = parseFloat(document.getElementById("to-lat").value);
    const toLon = parseFloat(document.getElementById("to-lon").value);
    const weight = parseFloat(document.getElementById("orderWeight").value || 1);

    const body = {
      pickup: { lat: fromLat, lon: fromLon },
      dropoff: { lat: toLat, lon: toLon },
      weight: weight,
      drone_id: 0
    };

    const res = await fetch("/api/start_mission", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (res.ok) {
      const data = await res.json();
      alert(`‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω! –ú–∏—Å—Å–∏—è ${data.mission_id}`);
    } else {
      alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞");
    }
  }

  // === –¶–≤–µ—Ç–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ ===
  function greenIcon() {
    return new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
  }

  function redIcon() {
    return new L.Icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
  }

  // –¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã –ø–æ –¥—Ä–æ–Ω–∞–º
  setInterval(() => {
    const markers = Object.values(droneMarkers);
    if (markers.length > 0) {
      const group = new L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.3));
    }
  }, 3000);
});
</script>
</body>
</html>
